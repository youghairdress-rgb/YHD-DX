<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AIパーソナル診断</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/style.css">
    
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" charset="utf-8"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tYHuRgEXEBOBS6qqSL9KxXfGPRCRHpTAfUuiQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Global Helper Functions -->
    <script>
        const escapeHtmlFallback = function(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\//g, "&#x2F;");
        };

        function initializeAppFailureFallback(errorMessage) {
            console.error("[initializeAppFailureFallback] Triggered with:", errorMessage);
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            const bodyElement = document.body || document.createElement('body');
            const safeErrorMessage = escapeHtmlFallback(errorMessage || "不明なエラー");
            bodyElement.innerHTML = `<div style="padding: 20px; text-align: center; color: red; background-color: #fff0f0; border: 1px solid red; border-radius: 8px; max-width: 600px; margin: 20px auto;"><h2>アプリケーションエラー</h2><p>${safeErrorMessage}</p><p>時間をおいて再度お試しください。</p></div>`;
            if (!document.body) document.documentElement.appendChild(bodyElement);
            bodyElement.style.cssText = `display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; min-height: 100vh; background-color: #f8fafc;`;
        }
    </script>

</head>
<body>
    <!-- ローディング画面 -->
    <div id="loading-screen" class="loading-container active">
        <div class="spinner"></div>
        <p>アプリを準備しています...</p>
    </div>

    <!-- Phase 1: Opening -->
    <div id="phase1" class="phase-container">
        <div class="card">
            <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Logo" class="logo">
            <h1 class="main-title"><font size="34px" color="#2dd4bf">YHD × AI</font><br>『似合わせ』診断</h1>
            <p class="description">
                お客様の『似合う』を実現するために<br>
                AIが分析し、最適なアドバイスを<br>伝えます！
            </p>
            <button id="start-btn" class="btn-primary">診断を始める</button>
        </div>
    </div>
    
    <!-- Phase 2: Profile Input -->
    <div id="phase2" class="phase-container">
        <div class="card">
            <h2 class="form-title">プロフィール入力</h2>
            <div class="form-group">
                <label for="display-name">お名前</label>
                <input type="text" id="display-name" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>性別</label>
                <div class="gender-selection">
                    <input type="radio" id="female" name="gender" value="female" checked> <label for="female">女性</label>
                    <input type="radio" id="male" name="gender" value="male"> <label for="male">男性</label>
                    <input type="radio" id="other" name="gender" value="other"> <label for="other">その他</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="user-requests">ご希望のメニューやご要望 (任意)</label>
                <textarea id="user-requests" class="form-control" rows="4" placeholder="（例）カットとカラー希望。赤みが出ないようにしたい。"></textarea>
            </div>

            <div class="form-group">
                <label for="inspiration-image-input">ご希望のスタイル写真 (任意)</label>
                <input type="file" id="inspiration-image-input" class="file-input" accept="image/*" hidden>
                
                <div id="inspiration-upload-container" class="inspiration-upload-container" role="button" tabindex="0">
                    <img id="inspiration-image-preview" alt="プレビュー">
                    <div class="inspiration-upload-icon-placeholder"></div> 
                    
                    <div class="inspiration-upload-text">
                        <strong id="inspiration-upload-title">写真を選択</strong>
                        <span id="inspiration-upload-status">タップして画像を選択</span>
                    </div>
                    <button id="inspiration-upload-btn" class="btn-outline">選択</button>
                    <button id="inspiration-delete-btn" class="btn-delete" style="display: none;">削除</button>
                </div>
            </div>

            <button id="next-to-upload-btn" class="btn-dark">撮影に進む</button>
        </div>
    </div>

     <!-- Phase 3: Upload -->
     <div id="phase3" class="phase-container">
         <div class="card">
             <h2 class="form-title">写真・動画撮影</h2>
             <p class="description" style="margin-bottom: 20px;">AI診断のため、指定されたアングルから撮影してください。</p>
             <div class="upload-list">
                 <div id="item-front-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/*" capture="environment" hidden>
                     <div class="upload-icon">📷</div><div class="upload-text"><strong>写真：正面</strong><span>顔がはっきりと</span></div><button class="btn-outline">撮影</button>
                 </div>
                 <div id="item-side-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/*" capture="environment" hidden>
                     <div class="upload-icon">📷</div><div class="upload-text"><strong>写真：サイド</strong><span>横顔と髪の長さ</span></div><button class="btn-outline">撮影</button>
                 </div>
                 <div id="item-back-photo" class="upload-item">
                     <input type="file" class="file-input" accept="image/*" capture="environment" hidden>
                     <div class="upload-icon">📷</div><div class="upload-text"><strong>写真：バック</strong><span>後ろ全体の髪型</span></div><button class="btn-outline">撮影</button>
                 </div>
                 <div id="item-front-video" class="upload-item">
                     <input type="file" class="file-input" accept="video/*" capture="environment" hidden>
                     <div class="upload-icon">🎬</div>
                     <div class="upload-text">
                         <strong>動画：正面 (3秒)</strong>
                         <span>顔を左右に動かす</span>
                     </div>
                     <button class="btn-outline">撮影</button>
                 </div>
                 <div id="item-back-video" class="upload-item">
                     <input type="file" class="file-input" accept="video/*" capture="environment" hidden>
                     <div class="upload-icon">🎬</div>
                     <div class="upload-text">
                         <strong>動画：バック (3秒)</strong>
                         <span>髪全体の動き</span>
                     </div>
                     <button class="btn-outline">撮影</button>
                 </div>
             </div>
             <button id="request-diagnosis-btn" class="btn-dark btn-disabled" disabled>AI診断をリクエスト</button>
         </div>
     </div>
     
     <!-- Phase 3.5: Loading -->
     <div id="phase3.5" class="phase-container">
         <div class="card">
             <div class="spinner"></div>
             <h2 class="form-title" style="margin-top: 25px; margin-bottom: 10px;">AIが診断中です</h2>
             <p class="description" id="diagnosis-status-text">しばらくお待ちください...</p>
         </div>
     </div>
     
     <!-- Phase 4: Diagnosis Result -->
    <div id="phase4" class="phase-container">
         <div class="card">
             <h2 class="form-title">AI診断結果</h2>
             
             <div class="result-section">
                 <h3 class="result-title"><img src="images/顔診断.png" alt="" class="result-icon"> お顔の特徴</h3>
                 <div id="face-results" class="result-grid"></div>
             </div>
             <div class="result-section">
                 <h3 class="result-title"><img src="images/骨格診断.png" alt="" class="result-icon"> 骨格・ボディ</h3>
                 <div id="skeleton-results" class="result-grid"></div>
             </div>
             <div class="result-section">
                 <h3 class="result-title"><img src="images/ヘアスタイル.png" alt="" class="result-icon"> 現在の髪の状態</h3>
                 <div id="hair-condition-results" class="result-grid"></div>
             </div>
             <div class="result-section">
                 <h3 class="result-title"><img src="images/パーソナルカラー.png" alt="" class="result-icon"> パーソナルカラー</h3>
                 <div id="personal-color-results" class="result-grid"></div>
             </div>
             
             <button id="next-to-proposal-btn" class="btn-dark">AI提案を見る</button>
             <button id="save-phase4-btn" class="btn-secondary no-print">診断結果を画像で保存</button>
         </div>
    </div>
     
     <!-- Phase 5: Proposal -->
    <div id="phase5" class="phase-container">
         <div class="card">
             <h2 class="form-title">AIパーソナル提案</h2>
             
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ヘアスタイル.png" alt="" class="proposal-icon"> 似合うヘアスタイル</h3>
                 <div id="hairstyle-proposal" class="proposal-grid"></div>
             </div>
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/ヘアカラー.png" alt="" class="proposal-icon"> 似合うヘアカラー</h3>
                 <div id="haircolor-proposal" class="proposal-grid"></div>
             </div>
             <!-- ★ トーン選択セクションはPhase 6へ移動のため削除 -->

             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/カラーパターン.png" alt="" class="proposal-icon"> 相性ベストカラー</h3>
                 <div id="best-colors-proposal" class="best-colors-grid"></div>
             </div>

             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/メイク.png" alt="" class="proposal-icon"> 似合うメイク</h3>
                 <div id="makeup-proposal" class="makeup-grid"></div>
             </div>
             
             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/骨格診断.png" alt="" class="proposal-icon"> 似合うファッション</h3>
                 <div id="fashion-proposal" class="makeup-grid"></div>
             </div>

             <div class="proposal-section">
                 <h3 class="proposal-title"><img src="images/AI美容師.png" alt="" class="proposal-icon"> AIからのアドバイス</h3>
                 <div class="top-stylist-comment">
                     <p id="top-stylist-comment-text"></p>
                 </div>
             </div>
             
             <!-- ★ Phase 5の生成ボタンを「設定へ進む」ボタンに変更 -->
             <button id="move-to-phase6-btn" class="btn-dark">画像生成の設定へ</button>
             <button id="save-phase5-btn" class="btn-secondary no-print">提案内容を画像で保存</button>
             <button id="back-to-diagnosis-btn" class="btn-secondary btn-secondary-white no-print">診断結果に戻る</button>
         </div>
    </div>
    
    <!-- Phase 6: Setup & Generated Image -->
    <div id="phase6" class="phase-container">
         <div class="card">
             <h2 class="form-title">画像生成シミュレーター</h2>

             <!-- ★★★ 画像生成設定セクション (新規追加) ★★★ -->
             <div id="generation-config-section" class="refinement-section">
                 <h3 class="refinement-title"><img src="images/ヘアスタイル.png" alt="" class="proposal-icon"> スタイルの選択</h3>
                 <!-- ui.js で動的にラジオボタンを生成 -->
                 <div id="style-selection-group" class="form-group"></div>

                 <h3 class="refinement-title" style="margin-top: 20px;"><img src="images/ヘアカラー.png" alt="" class="proposal-icon"> カラーの選択</h3>
                 <!-- ui.js で動的にラジオボタンを生成 -->
                 <div id="color-selection-group" class="form-group"></div>

                 <h3 class="refinement-title" style="margin-top: 20px;"><img src="images/ヘアカラー.png" alt="" class="proposal-icon"> 明るさ（トーン）</h3>
                 <div class="form-group">
                     <select id="hair-tone-select" class="form-control">
                         <option value="">AIにお任せ (提案通り)</option>
                         <option value="Tone 5">トーン 5: 自然な黒髪～暗めの栗色</option>
                         <option value="Tone 7">トーン 7: やや暗めの茶色</option>
                         <option value="Tone 9">トーン 9: 茶色～明るめの茶色</option>
                         <option value="Tone 11">トーン 11: 明るい茶色～金髪に近い茶色</option>
                         <option value="Tone 13">トーン 13: 明るい金髪</option>
                         <option value="Tone 15">トーン 15: 非常に明るい金髪 (ブリーチ必須)</option>
                         <option value="Tone 18">トーン 18: 白に近い金髪 (ホワイトブリーチ)</option>
                     </select>
                 </div>

                 <button id="generate-image-btn" class="btn-primary">合成画像を生成</button>
             </div>
             
             <!-- 生成結果表示エリア -->
             <div class="generated-image-container" style="margin-top: 30px; display: none;">
                 <img id="generated-image" src="" alt="合成されたヘアスタイル">
                 <div id="refinement-spinner" class="spinner" style="display: none;"></div>
             </div>
             
             <p id="generated-image-description" class="description"></p>

             <!-- 保存・共有ボタン群 (生成後に表示) -->
             <div id="post-generation-actions" style="display: none;">
                 <button id="save-generated-image-to-db-btn" class="btn-primary no-print">この合成画像を保存する</button>
                 <button id="share-phase6-btn" class="btn-secondary no-print">結果を保存してLINEで共有</button>
             </div>
             
             <button id="back-to-proposal-btn" class="btn-outline" style="margin-top: 20px;">提案に戻る</button>

             <button id="close-liff-btn" class="btn-secondary btn-secondary-white no-print">
                 アプリを終了する
             </button>
         </div>
    </div>

    <!-- カスタムモーダル (共通) -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">お知らせ</h3>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer">
                <button id="modal-ok-btn" class="btn-primary modal-btn">OK</button>
            </div>
        </div>
    </div>

    <script src="js/main.js" type="module"></script> 
</body>
</html>